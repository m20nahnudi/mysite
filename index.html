<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø´Ø®ØµÛŒ</title>
<style>
    body {
        font-family: "Vazir", Tahoma, sans-serif;
        background: linear-gradient(to bottom, #f9f9f9, #eaeaea);
        margin: 0;
        padding: 15px;
    }
    h1 {
        text-align: center;
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 15px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    th {
        background: #4CAF50;
        color: white;
        padding: 10px;
        font-weight: normal;
        font-size: 0.9rem;
    }
    td {
        padding: 8px;
        text-align: center;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 0.85rem;
        box-sizing: border-box;
        text-align: center;
    }
    button {
        padding: 6px 10px;
        cursor: pointer;
        border: none;
        font-size: 0.85rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    .btn-container {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 12px;
    }
    .add-btn { background: #4CAF50; color: white; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .add-btn:hover { background: #43a047; }
    .clear-btn { background: #f44336; color: white; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .clear-btn:hover { background: #d32f2f; }
    .del-btn { background: #f44336; color: white; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    .del-btn:hover { background: #d32f2f; }
    .plus-btn { background: #2196F3; color: white; margin-left: 5px; }
    .plus-btn:hover { background: #1976d2; }
    .tooltip { position: relative; display: inline-block; cursor: pointer; }
    .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: #555;
        color: #fff;
        text-align: right;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        right: 50%;
        margin-right: -100px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.8rem;
        line-height: 1.4;
        white-space: pre-line;
    }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    .totals {
        margin-top: 12px;
        display: flex;
        justify-content: space-around;
        font-weight: bold;
        font-size: 1rem;
    }
    @media (max-width: 800px) {
        table, thead, tbody, th, td, tr { display: block; }
        thead { display: none; }
        tr { background: #fff; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.05); padding: 10px; }
        td { display: flex; justify-content: flex-start; padding: 6px 0; border: none; border-bottom: 1px solid #eee; }
        td:last-child { border-bottom: none; }
        td::before { content: attr(data-label); font-weight: bold; color: #555; text-align: right; width: 35%; display: inline-block; }
        input { 
            width: 60%;
            font-size: 0.8rem;
            text-align: right;
        }
        .plus-btn, .del-btn { margin: 0; margin-right: auto; }
        .totals { flex-direction: column; gap: 5px; align-items: center; }
    }
</style>
</head>
<body>

<h1>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ Ø´Ø®ØµÛŒ</h1>

<table id="accountTable">
    <thead>
        <tr>
            <th>ØªØ§Ø±ÛŒØ®</th>
            <th>Ø´Ø±Ø­</th>
            <th>ØªØ¹Ø¯Ø§Ø¯</th>
            <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
            <th>Ø¬Ù…Ø¹ Ú©Ù„</th>
            <th>Ø¯Ø±ÛŒØ§ÙØªÛŒ</th>
            <th>Ù…Ø§Ù†Ø¯Ù‡ Ù‚Ø§Ø¨Ù„ Ø¯Ø±ÛŒØ§ÙØª</th>
            <th>Ø­Ø°Ù</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="btn-container">
    <button class="add-btn" onclick="addRow()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ</button>
    <button class="clear-btn" onclick="clearAll()">ğŸ—‘ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
</div>

<div class="totals">
    <div>Ø¬Ù…Ø¹ Ú©Ù„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§: <span id="totalSum">0</span></div>
    <div>Ø¬Ù…Ø¹ Ú©Ù„ Ø¯Ø±ÛŒØ§ÙØªÛŒâ€ŒÙ‡Ø§: <span id="totalReceived">0</span></div>
    <div>Ø¬Ù…Ø¹ Ú©Ù„ Ù…Ø§Ù†Ø¯Ù‡â€ŒÙ‡Ø§: <span id="totalRemaining">0</span></div>
</div>

<script>
function addRow(title = "", count = "", price = "") {
    let table = document.querySelector("#accountTable tbody");
    let row = document.createElement("tr");
    row.dataset.payments = JSON.stringify([]);
    let today = new Date();
    let dateStr = today.toLocaleDateString("fa-IR");
    row.innerHTML = `
        <td data-label="ØªØ§Ø±ÛŒØ®">${dateStr}</td>
        <td data-label="Ø´Ø±Ø­"><input value="${title}" oninput="saveData()"></td>
        <td data-label="ØªØ¹Ø¯Ø§Ø¯"><input type="number" value="${count}" oninput="updateTotals(); saveData()"></td>
        <td data-label="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯"><input type="number" value="${price}" oninput="updateTotals(); saveData()"></td>
        <td data-label="Ø¬Ù…Ø¹ Ú©Ù„">0</td>
        <td data-label="Ø¯Ø±ÛŒØ§ÙØªÛŒ">
            <div class="tooltip"><span class="received-amount">0</span>
            <span class="tooltiptext">Ù‡ÛŒÚ† Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</span></div>
            <button class="plus-btn" onclick="addPayment(this)">+</button>
        </td>
        <td data-label="Ù…Ø§Ù†Ø¯Ù‡ Ù‚Ø§Ø¨Ù„ Ø¯Ø±ÛŒØ§ÙØª">0</td>
        <td data-label="Ø­Ø°Ù"><button class="del-btn" onclick="this.closest('tr').remove(); updateTotals(); saveData();">âŒ</button></td>
    `;
    table.appendChild(row);
    updateTotals();
    saveData();
}

function addPayment(btn) {
    let amount = prompt("Ù…Ø¨Ù„Øº Ø¯Ø±ÛŒØ§ÙØªÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
    if (amount === null || amount.trim() === "" || isNaN(amount)) return;
    let payment = parseFloat(amount);
    let row = btn.closest("tr");
    let payments = JSON.parse(row.dataset.payments);
    let today = new Date();
    let dateStr = today.toLocaleDateString("fa-IR");
    payments.push({ amount: payment, date: dateStr });
    row.dataset.payments = JSON.stringify(payments);
    updateReceivedCell(row);
    updateTotals();
    saveData();
}

function updateReceivedCell(row) {
    let payments = JSON.parse(row.dataset.payments);
    let totalReceived = payments.reduce((sum, p) => sum + p.amount, 0);
    row.querySelector(".received-amount").innerText = totalReceived.toLocaleString();
    if (payments.length > 0) {
        let tooltipText = payments.map(p => `${p.amount.toLocaleString()} ØªÙˆÙ…Ø§Ù† - ${p.date}`).join("\n");
        row.querySelector(".tooltiptext").innerText = tooltipText;
    } else {
        row.querySelector(".tooltiptext").innerText = "Ù‡ÛŒÚ† Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡";
    }
}

function updateTotals() {
    let rows = document.querySelectorAll("#accountTable tbody tr");
    let totalSum = 0;
    let totalReceived = 0;
    let totalRemaining = 0;
    rows.forEach(row => {
        let count = parseFloat(row.cells[2].children[0].value) || 0;
        let price = parseFloat(row.cells[3].children[0].value) || 0;
        let total = count * price;
        totalSum += total;

        let payments = JSON.parse(row.dataset.payments);
        let received = payments.reduce((sum, p) => sum + p.amount, 0);
        totalReceived += received;

        let remain = total - received;
        totalRemaining += remain;

        row.cells[4].innerText = total.toLocaleString();
        row.cells[6].innerText = remain.toLocaleString();
        updateReceivedCell(row);
    });
    document.getElementById("totalSum").innerText = totalSum.toLocaleString();
    document.getElementById("totalReceived").innerText = totalReceived.toLocaleString();
    document.getElementById("totalRemaining").innerText = totalRemaining.toLocaleString();
}

function clearAll() {
    if (confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù‡Ù…Ù‡ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ")) {
        document.querySelector("#accountTable tbody").innerHTML = "";
        updateTotals();
        localStorage.removeItem("accountData");
    }
}

// Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø¯ÙˆÙ„ Ø¯Ø± LocalStorage
function saveData() {
    let rows = document.querySelectorAll("#accountTable tbody tr");
    let data = [];
    rows.forEach(row => {
        let title = row.cells[1].children[0].value;
        let count = row.cells[2].children[0].value;
        let price = row.cells[3].children[0].value;
        let payments = JSON.parse(row.dataset.payments);
        let date = row.cells[0].innerText;
        data.push({ date, title, count, price, payments });
    });
    localStorage.setItem("accountData", JSON.stringify(data));
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
function loadData() {
    let data = JSON.parse(localStorage.getItem("accountData") || "[]");
    data.forEach(item => {
        addRow(item.title, item.count, item.price);
        let lastRow = document.querySelector("#accountTable tbody tr:last-child");
        lastRow.cells[0].innerText = item.date;
        lastRow.dataset.payments = JSON.stringify(item.payments);
        updateReceivedCell(lastRow);
    });
    updateTotals();
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø´Ø±ÙˆØ¹ ØµÙØ­Ù‡
window.onload = loadData;
</script>

</body>
</html>